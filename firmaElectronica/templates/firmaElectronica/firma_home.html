<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firma Electrónica</title>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="left">
            <a href="{% url 'agenda_home' %}">Agenda</a>
            <a href="{% url 'firma_home' %}">Firma Electrónica</a>
        </div>
        <div class="logo">Mi Empresa</div>
        <div class="right">
            {% if user.is_authenticated %}
                <span class="username">{{ user.username }}</span>
                <form method="POST" action="{% url 'logout' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" style="background: none; border: none; color: #ffffff; text-decoration: none; cursor: pointer; padding: 0;">
                        Cerrar sesión
                    </button>
                </form>
            {% else %}
                <a href="{% url 'registro' %}">Registrarse</a>
                <a href="{% url 'login' %}">Iniciar Sesión</a>
            {% endif %}
        </div>
    </nav>


    <!-- Contenido -->
    <div class="container">
        <h1 class="text-center mb-4">Firma Electrónica</h1>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="file_in">Seleccione el archivo PDF:</label>
                <input type="file" name="file_in" id="file_in" accept=".pdf" multiple required onchange="previewPDF(event)">
            </div>
            <ul id="fileList" class="list-unstyled small text-muted mt-2"></ul>
            <button id="btnAbrirModal" type="button" class="btn btn-primary btn-lg w-100" disabled>
                Firmar
            </button>
        </form>

    
        {% if response %}
        <div class="alert alert-success">
            {{ response }} - ID de firma: {{ api_id }}
        </div>
        {% elif error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
        {% endif %}

        <div id="pdfPreview" style="margin-top: 20px;">
            <h2>Vista Previa del PDF</h2>
            <!-- Dropdown de selección de documento -->
            <div class="dropdown mb-2 d-none" id="previewDropdownWrap">
            <button id="previewBtn" class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                Selecciona un archivo
            </button>
                <ul id="previewMenu" class="dropdown-menu"></ul>
            </div>
            <embed id="pdfEmbed" src="" type="application/pdf" width="100%" height="500" style="display: none;"></embed>
        </div>

    </div>

    <!-- Modal de credenciales -->
    <div class="modal fade" id="modalCredenciales" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formCredenciales" class="modal-content">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title">Credenciales de Firma</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                <label class="form-label">Usuario</label>
                <input type="text" name="sign_user" class="form-control" required minlength="3" autocomplete="username">
                </div>
                <div class="mb-3">
                <label class="form-label">Contraseña</label>
                <input type="password" name="sign_password" class="form-control" required minlength="4" autocomplete="current-password">
                </div>
                <div class="mb-3">
                <label class="form-label">PIN</label>
                <input type="password" name="sign_pin" class="form-control" required minlength="4">
                </div>
                <div id="alertaModal" class="alert alert-danger d-none"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarFirma" type="submit" class="btn btn-primary">Firmar</button>
            </div>
            </form>
        </div>
    </div>

    <!-- Modal Resultado -->
    <div class="modal fade" id="modalResultado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Resultado de la firma</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <ul id="resultadoLista" class="list-group"></ul>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
        </div>
        </div>
    </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div>© 2024 Mi Empresa. Todos los derechos reservados.</div>
        <div class="socials">
            <a href="https://www.facebook.com/camaradecomerciodeguatemala/?locale=es_LA" target="_blank"><i class="fab fa-facebook-f"></i></a>
            <a href="https://www.instagram.com/camaradecomerciodeguatemala/?hl=es" target="_blank"><i class="fab fa-instagram"></i></a>
            <a href="https://wa.me/50224172700" target="_blank"><i class="fab fa-whatsapp"></i></a>
        </div>
    </footer>


    <script>

        function isPdf(file){ return file.type==='application/pdf' || /\.pdf$/i.test(file.name); }

        function loadPreviewFile(file){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const embed = document.getElementById('pdfEmbed');
            embed.src = e.target.result;
            embed.style.display = 'block';
        };
        reader.readAsDataURL(file);
        }

        // Truncar nombres largos para mostrar en el botón y el menú
        function ellipsize(name, max = 70) {
        if (name.length <= max) return name;
        const head = name.slice(0, Math.floor(max * 0.6));
        const tail = name.slice(-Math.floor(max * 0.3));
        return head + '…' + tail;
        }

        // Poner el label del botón
        function setPreviewLabel(name){
        document.getElementById('previewBtn').textContent = ellipsize(name, 60);
        document.getElementById('previewBtn').title = name;
        }

        // Llenar el menú del dropdown
        function fillPreviewMenu(files){
        const menu = document.getElementById('previewMenu');
        menu.innerHTML = '';
        files.forEach((f, idx) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.textContent = ellipsize(f.name, 80);
            a.title = f.name;
            a.href = '#';
            a.addEventListener('click', (e) => {
            e.preventDefault();
            setPreviewLabel(f.name);
            loadPreviewFile(files[idx]);
            });
            li.appendChild(a);
            menu.appendChild(li);
        });
        }

        // Handler del input de archivos
        function previewPDF(event){
        const files = [...(event.target.files || [])];
        const list = document.getElementById('fileList');
        const ddWrap = document.getElementById('previewDropdownWrap');
        list.innerHTML = '';

        // No hay archivos
        if(!files.length){
            ddWrap.classList.add('d-none');
            document.getElementById('pdfEmbed').style.display = 'none';
            document.getElementById('btnAbrirModal').disabled = true;
            return;
        }

        // Validar que todos sean PDF
        const allPdf = files.every(isPdf);
        document.getElementById('btnAbrirModal').disabled = !allPdf;

        // Poblar la lista de nombres (arriba del botón)
        files.forEach(f => {
            const li = document.createElement('li');
            li.textContent = f.name;
            li.title = f.name;
            li.classList.add('ellipsis');
            list.appendChild(li);
        });

        // Mostrar dropdown si hay más de 1 archivo
        if(files.length > 1){
            ddWrap.classList.remove('d-none');
        }else{
            ddWrap.classList.add('d-none');
        }

        // Llenar menú y setear preview inicial
        fillPreviewMenu(files);
        setPreviewLabel(files[0].name);
        loadPreviewFile(files[0]);

        // Guarda los archivos en una variable global por si luego quieres usarlos
        window.__selectedPdfFiles = files;
        }


        (function () {
        const btnAbrirModal = document.getElementById('btnAbrirModal');
        const formCred = document.getElementById('formCredenciales');
        const alerta = document.getElementById('alertaModal');

        // 1) Habilitar “Firmar” cuando haya archivo seleccionado
        const inputPdf = document.querySelector('#file_in');
        if (inputPdf) {
        inputPdf.addEventListener('change', () => {
            const files = inputPdf.files || [];
            const ok = files.length > 0 && [...files].every(isPdf);
            btnAbrirModal.disabled = !ok;
        });
        }

        // 2) Abrir modal
        btnAbrirModal.addEventListener('click', () => {
            alerta.classList.add('d-none');
            formCred.reset();
            const m = new bootstrap.Modal(document.getElementById('modalCredenciales'));
            m.show();
        });

        // CSRF para fetch
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const csrftoken = getCookie('csrftoken');

        // 3) Enviar archivo + credenciales al backend
        formCred.addEventListener('submit', async (e) => {
        e.preventDefault();
        alerta.classList.add('d-none');

        const fd = new FormData();

        // Archivo(s)
        if (!inputPdf || !inputPdf.files.length) {
            alerta.textContent = 'Selecciona al menos un PDF.';
            alerta.classList.remove('d-none');
            return;
        }
        // Si tu vista soporta uno, usa el primero. Si ya soporta varios, itera:
        for (const f of inputPdf.files) {
            fd.append('file_in', f);
        }

        // Credenciales (NO las loggees)
        fd.append('sign_user', formCred.elements['sign_user'].value);
        fd.append('sign_password', formCred.elements['sign_password'].value);
        fd.append('sign_pin', formCred.elements['sign_pin'].value);

        // Cualquier otro campo que tu vista ya esperaba (p.ej. reason, location…)
        // fd.append('reason', '{{ settings.SIGNBOX_REASON }}'); // opcional si la vista lo arma sola

        // Deshabilitar botón mientras firma
        const btn = document.getElementById('btnConfirmarFirma');
        btn.disabled = true;
        btn.textContent = 'Firmando…';

        try {
            const resp = await fetch("{% url 'firma_home' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: fd
            });

            if (!resp.ok) {
            const txt = await resp.text();
            throw new Error(txt || 'Error en la firma');
            }

            // Respuesta esperada: JSON con { ok: true, api_id, mensaje } o similar
            const data = await resp.json().catch(() => ({}));
            if (data.ok) {
            bootstrap.Modal.getInstance(document.getElementById('modalCredenciales')).hide();
            formCred.reset();

            // Render rápido: resumen en alert
            const lines = (data.results || []).map(r =>
                r.status === 'ok'
                ? `✅ ${r.filename} → API ID: ${r.api_id}`
                : `❌ ${r.filename} → ${r.error || 'Error'}`
            ).join('\n');

            // Cerrar modal de credenciales
            bootstrap.Modal.getInstance(document.getElementById('modalCredenciales')).hide();

            // Limpiar campos de credenciales
            formCred.reset();

            // Llenar lista en el modal de resultados
            const lista = document.getElementById('resultadoLista');
            lista.innerHTML = '';
            (data.results || []).forEach(r => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            li.innerHTML = `
                <div class="ms-2 me-auto">
                <div class="fw-bold">${r.filename}</div>
                ${r.status === 'ok'
                    ? `API ID: <code>${r.api_id}</code>`
                    : `<span class="text-danger">${r.error || 'Error'}</span>`}
                </div>
                <span class="badge ${r.status === 'ok' ? 'bg-primary' : 'bg-danger'} rounded-pill">
                ${r.status === 'ok' ? 'Enviado' : 'ERR'}
                </span>
            `;
            lista.appendChild(li);
            });

            // Mostrar modal de resultados
            new bootstrap.Modal(document.getElementById('modalResultado')).show();

            // Limpiar archivos y preview
            document.getElementById('file_in').value = '';
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('pdfEmbed').style.display = 'none';
            document.getElementById('previewDropdownWrap').classList.add('d-none');
            document.getElementById('btnAbrirModal').disabled = true;
            } else {
            const firstErr = (data.results || []).find(r => r.status === 'error');
            throw new Error(firstErr?.error || data.error || 'No se pudo firmar.');
            }
        } catch (err) {
            alerta.textContent = ('' + err.message).includes('PIN') ? 'PIN incorrecto' :
                                ('' + err.message).includes('credencial') ? 'Credenciales inválidas' :
                                'No se pudo completar la firma. Intenta de nuevo.';
            alerta.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Firmar';
            // Limpia los campos sensibles del modal
            formCred.elements['sign_password'].value = '';
            formCred.elements['sign_pin'].value = '';
        }
        });
    })();

    </script>

    <style>
        *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
        body{background:#f5f6f8;margin:0}
        .container{
            max-width: 1000px; margin: 24px auto; padding: 24px;
            background:#fff; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06);
            min-height: calc(100vh - 162px);
        }
        h1{font-weight:700; letter-spacing:.2px}
        label{font-weight:600; margin-bottom:.25rem}
        input[type="file"]{padding:.65rem; border:1px solid #dfe3ea; border-radius:.5rem}
        #fileList li{padding:.25rem 0}
        #pdfEmbed{border:1px solid #e9ecef; border-radius:.5rem}
        /* Navbar/Footer básicos (si los usas) */
        .navbar, .footer{background:#2d2f33; color:#fff}
        .navbar a, .footer a{color:#fff; text-decoration:none}
        .navbar a:hover, .footer a:hover{opacity:.85}
        /* Modal: botones consistentes */
        .modal-footer .btn-primary{min-width:120px}
        #fileList{max-height: 120px; overflow:auto}

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #333;
            color: white;
        }

        .navbar .left, .navbar .right {
            display: flex;
            gap: 15px;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        .navbar a:hover {
            text-decoration: underline;
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
        }

        #fileList { max-height: 120px; overflow: auto; }
        #fileList li.ellipsis { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* Opcional: margen al preview para que el dropdown no lo tape visualmente */
        #pdfEmbed { margin-top: .25rem; }

        #previewSelector {
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #previewSelector option {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


    </style>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>